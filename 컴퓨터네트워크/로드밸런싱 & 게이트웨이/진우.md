# [Network] 로드밸런싱 & 게이트웨이

## 1. 로드밸런싱

컴퓨터 네트워크 기술의 일종으로, n개의 자원들에게 작업(부하, Load)를 나누어 주는 것이다.

<img width="737" alt="image" src="https://github.com/user-attachments/assets/74072889-94b6-45f3-abdf-4048a03ebe17">

### 1.1. 로드밸런싱의 기본 기능

- **Health Check**
    
    서버에 주기적인 체킹을 통해 **서버의 장애 여부**를 파악한다.
    → 정상 동작하는 서버로만 트래픽을 보냄
    
    - L3 체크(Network Layer) : **ICMP** 프로토콜을 이용하여 IP주소가 통신 가능한 상태인지 파악
    - L4 체크(Transport Layer) : **TCP** 프로토콜의 3way handshake를 이용하여, **각 포트**의 상태를 체크
    - L7 체크(Apllication Layer) : 실제 웹 페이지에 통신을 시도
    
    > ICMP[Internet Control Message Protocol]
    > 
    > 
    > : 인터넷 제어 메시지 프로토콜
    > 
    > 오류 메세지를 전송받는 데 주로 쓰입니다.
    > 

- **Tunneling** : 터널링
    
    데이터 스트림을 인터넷 상의 가상 파이프를 이용하여 전달시키는 기술
    
    패킷 내에 터널링할 대상을 캡슐화시켜 전송하며, 연결된 상호 간에만 캡슐화된 패킷을 구분하여 캡슐화를 해제한다.
    

- **NAT**
    
    NAT는, 하나의 public ip를 통해 여러개의 private ip로 접속하게 하는 것이 목적이다.
    
    로드밸런싱 관점에서, 여러개의 호스트가 하나의 공인IP로 접속하는 것이 주 목적이다.(?)
    

### 1.2. 로드밸런싱 알고리즘

- **RR**
    
    서버로 들어온 요청을 순서대로 배정하는 방식
    
- **가중치 RR**
    
    서버마다 가중치를 매기고, 가중치가 높은 서버(처리율이 좋은 서버?)에 요청을 우선적으로 배치함.
    서버의 트래픽 처리 능력이 다른 경우 사용
    
- **Hash**
    
    사용자의 ip를 해싱하여 부하를 분산하는 방식. 
    → 사용자가 항상 동일한 서버로 연결되는 것을 보장한다.
    
- **최소 연결 방식(Least Connection)**
    
    요청이 들어온 시점에, 커넥션이 가장 적은 서버에 할당
    
- **최소 응답시간 방식(Least Response Time)**
    
    서버의 연결 상태와 응답시간을 고려하여, 가장 짧은 응답 시간을 가지는 서버에 트래픽을 할당
    

## 2. 로드밸런서의 종류

L4, L7 로드밸런서가 가장 많이 사용된다.

### 2.1. L4 로드 밸런서

<img width="731" alt="image" src="https://github.com/user-attachments/assets/99b1f676-5832-410c-a131-e4b89b25431a">

Ip, TCP, UDP 등의 정보를 바탕으로 로드 분산

한 대의 서버에 다수의 프로그램을 운영하여, 포트를 다르게 할 경우 사용하기 좋다.

→ 한 대의 서버라는 것은, L3(Network layer) 까지 목적지가 같다.

- 장점
    - 패킷의 내용을 확인하지 않아도 되어서 빠르다.
    - 데이터 복호화가 필요없어서 안전
    - 저렴
- 단점
    - 패킷의 내용을 볼 수 없음 → 섬세한 라우팅 불가능

### 2.2. L7로드 밸런서

<img width="769" alt="image" src="https://github.com/user-attachments/assets/89353a74-eacf-488d-916e-aaabfffbaca8">

Application Layer에서 로드를 분산함. HTTP 헤더, 쿠키 등 사용자의 요청을 기준으로 트래픽을 분산

네트워크 상에서 각각의 서버에 프로그램을 실행시키는 경우

- 장점
    - 상위 계층에서 로드 분산 → 섬세한 라우팅 가능
    - 캐싱 가능
    - 안정성 노픙ㅁ
- 단점
    - 비쌈

## 3. 게이트웨이

**게이트웨이**는, 한 네트워크에서 다른 네트워크와 연결해주는 장치 또는 소프트웨어를 말한다.

서로다른 네트워크를 연결하고 통신을 가능하게 하며, 네트워크 트래픽을 전달한다.

주로 네트워크의 경계에 사용되며, 내부-외부 네트워크 사이의 통신을 중계한다.

### 3.1. 인터넷 게이트웨이

- AWS같은 클라우드 서비스에서, VPC(Virtual Private Cloud)와 인터넷의 트래픽을 **라우팅**하는 가상 장치
- VPC 내부의 리소스가 VPC외부와 통신할 수 있게 하며, **라우팅 테이블**을 가진다.

### 3.2. API 게이트웨이

- 여러가지 api를 단일 진입점에서 관리하고 라우팅하는 서비스
- 각종 api 요청을 처리하여, 필요한 서비스로 라우팅한다.

### 3.3. NAT 게이트웨이

- VPC 내의 프라이빗 서브넷에서, 인터넷(VPC 외부)로 접근 가능하도록 하는 게이트웨이
- 보안 목적을 위해 사용하며, 아웃바운드에만 사용

## 4. 로드밸런서 vs api 게이트웨이

- 로드밸런서
    - 네트워크 트래픽에 관심을 가진다.
    - 요청의 validaition이 아닌, 요청을 처리할 수 있는 서버의 네트워크 상태, 과부하 여부 등을 파악한다.
- api 게이트웨이
    - 요청 자체에 관심을 가진다.
    - 요청이 올바른지, 라우팅이 잘 되는지, 인증, 인가 등을 처리한다.
