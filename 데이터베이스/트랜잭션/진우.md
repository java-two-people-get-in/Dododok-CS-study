# [Database] 트랜잭션

## 1. 트랜잭션?

데이터베이스의 상태를 변화시키기 위해 수행하는 **작업의 단위**

트랜잭션은 더이상 분할할 수 없는 단위이며, **한꺼번에 수행되어야 할 연산의 모음**이다.

→ 그렇다고 트랜잭션이 하나의 쿼리문으로 이루어진다는 뜻은 아니다!

### [계좌이체] 트랜잭션

상황 : A계좌에서 B계좌로 10000원을 송금한다.

1. A계좌의 잔액을 조회(SELECT)
2. A계좌에서 10000원을 차감(UPDATE)
3. B계좌의 잔액을 조회(SELECT)
4. B계좌에 10000원을 더함(UPDATE)

→ 위의 과정 중 하나라도 완료가 되지 않은 상태에서 버그가 발생한다면 어떻게 하지?

## 2. 트랜잭션의 특징

### Atomicity(원자성)

트랜잭션 실행 도중 문제가 발생한 경우, **모두 실패하거나 모두 성공**이 되어야 한다.

### Consistency(일관성)

트랜잭션 완료 후에도 데이터베이스가 일관된 상태로 유지되어야 한다.(??????)

- 트랜잭션이 일어난 이후의 데이터베이스도, 이전의 **제약이나 규칙**을 만족해야 한다.
- *A계좌 잔액 +  B계좌 잔액*이 동일해야 한다.

### Isolation(고립성, 독립성)

트랜잭션(단위)은 독립적으로 동작함을 보장받아야 한다.

하나의 트랜잭션이 실행하는 도중 변경한 데이터는, 다른 트랜잭션이 참조할 수 없다.
→ **즉, 트랜잭션이 실행되는 도중에는 (해당 데이터에 대해)다른 연산이 수행되면 안된다는 것이다!**

### Durability(지속성)

트랜잭션이 성공적으로 완료되었다면 결과는 영구적으로 반영되어야 한다는 것이다.

→ 트랜잭션이 완료되었다면, 어떠한 형태로든 **데이터를 복구할 수 있어야 한다.**

→ 트랜잭션의 로그가 기록되어야 한다!!

## 3. Commit과 Rollback

### Commit 연산

하나의 트랜잭션이 성공적으로 끝났고 데이터베이스가 일관성있는 상태에 있을 때 **트랜잭션이 끝났다는 것**을 알려주기 위한 연산.

`commit`연산을 하면 트랜잭션이 로그에 저장되며, `rollback` 연산을 할 때 트랜잭션 단위로 하도록 도와준다.

### Rollback 연산

하나의 트랜잭션이 **비정상적으로 종료**되어 트랜잭션의 원자성을 만족하지 못할 때, **처음부터 시작**하거나 **부분적**으로 연산된 결과를 다시 취소하는 것

## 4. 트랜잭션의 회복 기법

회복? 데이터베이스에 장애가 발생했을 때,  발생하기 이전의 **일관된 상태로 복구시키는 것.**

### 회복을 위해 데이터베이스 복사본을 만드는 방법

- 덤프 : 데이터베이스 전체를 다른 저장장치에 주기적 복사
- 로그 : 데이터베이스에서 변경 연산이 실행될 때 마다, **변경 이전의 값과 이후의 값**을 파일에 기록하는 방법

### 회복을 위한 기본 연산 - UNDO, 취소

트랜잭션이 실패했을 때, 또는 사용자가 명시적으로 롤백을 요청시 사용한다.

트랜잭션이 실행된 이후 발생한 **모든 변경 사항을 취소**하고 트랜잭션 시작 전의 상태로 돌린다.

- `ROLLBACK` 연산이 `UNDO` 연산을 이용하여 트랜잭션에서 발생한 변경을 취소하는 것이다.

### 회복을 위한 기본 연산 - REDO ,재실행

가장 최근에 저장한 데이터베이스 복사본을 가져와, 로그를 이용하여 **복사본이 만들어진 이후의 변경 연산을 재실행**한다. 따라서 장애 발생 직전의 데이터베이스 상태로 복구한다.

데이터베이스 복구에 사용되며, 트랜잭션이 성공적으로 완료된 후 데이터베이스에 기록된 변경사항이 저장되기 전에
