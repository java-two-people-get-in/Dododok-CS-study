# [데이터베이스] 트랜잭션

## 트랜잭션(Transaction)
데이터베이스의 상태를 변화시키는 작업의 단위이다.

데이터베이스의 상태를 변화시킨다는 의미는 SELECT,INSERT,UPDATE,DELETE 등과 같은 데이터베이스 조작어(DML)사용하는 것을 의미한다.

## 트랜잭션을 사용하는 이유
* 데이터베이스에서 데이터를 다룰 때 장애가 일어나는 경우가 있다. 트랜잭션은 장애 발생시 데이터를 복구하는 작업의 단위가 된다.
* 데이터베이스에서 여러 작업이 동시에 같은 데이터를 다룰 때가 있다. 트랜잭션은 이 작업을 서로 분리하는 단위가 된다.

## 트랜잭션 연산
![image](https://github.com/user-attachments/assets/34f4ac83-00ea-49ea-9074-ccc07b550d3e)

1. Commit : 하나의 트랜잭션이 성공적으로 종료된 후, 데이터베이스가 일관된 상태를 유지할 때 갱신 연산이 완료되었다고 트랜잭션 관리자에게 알려주고 결과를 최종적으로 데이터베이스에 반영하는 연산이다. 
2. Rollback : Rollback 연산은 하나의 트랜잭션이 비정상적으로 종료되어 데이터베이스의 일관성을 잃었을 때 트랜잭션이 지금까지 실행한 연산의 결과가 취소되고 트랜잭션 수행 이전의 상태로 돌아가는 연산이다. Rollback을 하는 경우엔 해당 트랜잭션을 재시작하거나 폐기한다. 
3. SavePoint : 저장점의 역할을 하며 롤백할 때 트랜잭션에 포함된 전체 작업을 롤백하는 것이 아니라, 현 시점에서 SAVEPOINT까지 트랜잭션의 일부만 롤백할 수 있다.
```
BEGIN;
INSERT INTO 사용자 VALUES (1, 'John');
SAVEPOINT sp1; -- 저장점 생성

DELETE FROM 주문 WHERE 주문번호=1234;
SAVEPOINT sp2; -- 다른 저장점 생성

INSERT INTO 주문 VALUES (1234, '2022-01-01');
COMMIT; -- 트랜잭션 성공적으로 완료

-- 트랜잭션 중간에서 롤백
ROLLBACK TO sp1; -- sp1 이후 작업 취소, 주문 삭제 취소
```

## 트랜잭션 상태
![image](https://github.com/user-attachments/assets/6a8aabb1-71d2-455c-b7b7-2d44d4d5643a)

1. 활성화(Active) : 트랜잭션이 작업을 시작하여 실행 중인 상태
2. 실패(Failed) : 트랜잭션에 오류가 발생하여 실행이 중단된 상태
3. 철회(Aborted) : 트랜잭션이 비정상적으로 종료되어 Rollback 연산을 수행한 상태
4. 부분 완료(Partially commited) : 트랜잭션의 마지막 연산까지 실행하고 commit 요청이 들어온 직후의 상태. 최종 결과를 데이터베이스에 아직 반영하지 않은 상태.
5. 완료(Commited) : 트랜잭션이 성공적으로 종료되어 commit 연산을 실행한 후의 상태

## 트랜잭션 수행 과정
데이터베이스의 데이터는 하드디스크에 저장되어 있고, 처리를 위해서는 반드시 주기억장치 버퍼로 사본을 읽어와야 한다.
```
START TRANSACTION - 1.트랜잭션 시작

UPDATE balance=balance-10000 -- 2.UPDATE 진행

COMMIT -- 3.부분완료

4. 변경된 값을 기록
```
1. 트랜잭션 시작
* 로그파일에 로그 일련번호와 트랜잭션 아이디가 이어서 기록된다.
2. UPDATE 진행
* balance값을 하드디스크(데이터베이스)에서 주기억장치 버퍼로 읽어온다.
* 데이터 버퍼의 'balance'값을 'balance-1000'으로 변경한다.
* "UPDATE balance=balance-10000"와 로그 일련번호, 트랜잭션 아이디를 함께 로그 파일에 기록한다.
* 여기서 중요한 점은 아직 COMMIT 전이므로 데이터베이스의 값이 변경된 것은 아니다.
3. COMMIT(부분 완료)
* 데이터베이스에 변경된 값이 반영되지 않았지만 DBMS는 사용자에게 완료 사실을 알린다. 데이터베이스에 변경된 데이터를 기록하는 일은 DBMS가 책임지고 수행한다.
* 이렇게 하는 이유는 DBMS가 동시에 많은 트랜잭션을 수행할 때, 각각의 트랜잭션이 하드디스크에 개별 접근하는 것을 피하고 DBMS가 일괄적으로 하드디스크에 접근하여 처리함으로써 사용자에게 빠른 응답성을 보장하기 위해서이다.
4. 변경된 값을 기록
* 주기억장치 버퍼의 변경된 데이터를 차례대로 하드디스크(데이터베이스)에 적용시켜 데이터를 변경한다.

## 트랜잭션의 4가지 성질 : ACID
트랜잭션은 데이터베이스의 무결성을 유지하기 위해 원자성, 일관성, 고립성, 지속성의 성질을 갖는다.
### 원자성(Atomicity)
트랜잭션에 포함된 작업은 전부 수행되거나 아니면 전부 수행되지 않아야한다.(All or Nothing)
### 일관성(Consistenty)
트랜잭션을 수행하기 전이나 수행한 후나 데이터베이스는 항상 일관된 상태를 유지해야 한다. 즉, DB의 제약조건을 위배하는 작업을 트랜잭션 과정에서 수행할 수 없음을 나타낸다.

ex)송금 시 금액의 데이터 타입을 정수형에서 문자형으로 변경할 수 없다.
### 독립성(Isolation)
트랜잭션 수행 시 다른 트랜잭션의 작업이 끼어들지 못하도록 보장해야 한다. 즉, 둘 이상의 트랜잭션이 동시에 병행 실행되고 있을 때, 어떤 트랜잭션도 다른 트랜잭션 연상에 끼어들 수 없다.

독립성을 유지하기 위해서는 변경 중인 데이터를 다른 트랜잭션이 읽거나 쓰려할 때 제어하는 작업이 필요하다. 이 작업을 동시성 제어라고 한다.
### 지속성(Durability)
트랜잭션이 성공적으로 완료되었으면, 변경된 데이터는 영구적으로 저장되어야 한다. 저장된 데이터베이스는 저장 직후 혹은 어느 때나 발생할 수 있는 정전,장애,오류에 영향을 받지 않아야 한다.
