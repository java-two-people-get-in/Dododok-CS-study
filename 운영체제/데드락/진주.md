# Deadlock (교착상태)

## 1 교착 상태란?

둘 이상의 프로세스가 각자 가지고 있던 자원을 보유한 채로 외부적 조치가 없는 한 영원히 그 상태에서 기다리고 있는(Blocked) 상황

![image](https://github.com/java-two-people-get-in/Dododok-CS-study/assets/102593738/d997683f-f4b3-43f2-9499-60bb76c640d7)

**교착 상태의 근본 원인**

- 시스템이 가지고 있는 한정적인 자원보다 사용하고자 하는 프로세스들의 요청이 더 많기 때문

### Quiz! 교착 상태와 무한 대기의 차이점?

운영체제가 많은 프로세스들의 다양한 요청을 처리해 주다보면 몇몇 프로세스가 매우 오랜 시간 동안 서비스를 받지 못하는 경우가 생길 수 있다. 이는 교착 상태와 매우 유사한 현상을 보이는데… 교착 상태와 무한 대기의 차이점은 무엇일까?

## 1.1 자원이란?

### 1) 선점 가능성에 따라

| 선점 가능 자원 | 선점 불가능 자원 |
| --- | --- |
| 한 프로세스에 의해 사용 도중 선점되어 다른 프로세스에게 할당해주었다가 이후 다시 원래의 프로세스에게 돌려주어도 됨 | 선점이 될 경우 자원을 뺏긴 프로세스는 정상적인 진행을 포기해야 함 |
| ex) CPU, 메모리 | ex) 프린터, 테이프 드라이브 등 |

### 2) 자원 활용 방식에 따라

| 공유 가능 자원 | 배타적 자원 |
| --- | --- |
| 한 프로세스에게 할당된 자원을 동시에 다른 프로세스가 할당받아 같이 사용할 수 있음 | 한 프로세스에게 할당된 자원을 동시에 다른 프로세스가 할당받아 같이 사용할 수 없음 |
| ex) 공유 가능 프로그램(시스템 프로그램, 유틸리티 프로그램), 공유 데이터 등 | ex) CPU, 메모리, 테이프, 버퍼 등 |

<br/><br/>

## 1.2 프로세스란?

### - 실행 중인 프로세스가 자원에 대해 취할 수 있는 행동 2가지

**1) 필요한 자원에 대한 요청(Request)**

- 요청된 자원의 사용이 가능
    - 자원을 할당받아 사용
- 요청된 자원의 사용이 불가능
    - 반납되어질 때까지 대기 상태로 기다려야 함
    
    **★ 대기 상태의 프로세스는 자력으로 그 상태에서 벗어날 수 없으며, 따라서 자원의 요청이나 반납과 같은 행동을 더 이상 할 수 없다!**
    

**2) 사용이 끝난 자원을 반납**

: 자원에 대한 요청과 반납은 실행 중인 프로세스가 시스템 서비스를 호출(System Call)함으로써 운영체제에 의해 이루어지며, 반납된 자원으로 그 자원 때문에 대기 중인 프로세스를 깨우는 것도 운영체제이다. 

⇒ 다른 프로세스가 가졌기 때문에 현재 사용이 불가능한 자원을 요청한 후 대기 상태가 되는 프로세스들이 점점 늘어나 서로 엮이면..?

⇒ 이들은 모두 대기 상태가 되어버림 (= Deadlock)

<br/><br/>

## 1.3 교착 상태의 원인?

아래 4가지 조건들이 모두 갖춰질 때 교착 상태가 발생한다. 만약, 이 중 한 가지 조건이라도 만족하지 않는다면 교착상태는 절대! 발생하지 않는다.

### 1) 자원의 배타적인 사용

- 만약 자원이 한저적이라도 모두 공유 가능한 자원이라면 교착 상태는 발생할 수 없다.
- 다시 말해 시스템이 보유한 자원 중 배타적 사용이 요구되는 자원 때문에 교착 상태가 발생하는 것
- = 상호배제 조건(Mutual Exclusion Condition)

### 2) 자원의 부분 할당(Partial Allocation)

- 각각의 프로세스는 자신의 실행 전체 과정에서 필요한 자원을 필요할 때마다 일부분씩 확보한다.
- 이렇게 실행해나가다 어느 시점에 할당이 불가능한 자원 때문에 이미 확보한 자원들을 소유한 채 대기 상태가 되어버리면서 교착 상태에 빠질 가능성을 높인다.
- = 보유와 대기 (Hold&Wait) 조건
- **[해결책] all at once (=all or none)**

### 3) 자원의 선점 불가능성

- 선점이 불가능한 자원을 억지로 선점 되도록 하면…
    - 자원 때문에 대기할 필요가 없기에 교착 상태는 피할 수 있으나,
    - 자신의 자원을 선점당한 프로세스들은 정상적인 실행을 포기해야 한다.
- = 비선점(No Preemption) 조건

### 4) 자원에 대한 환형 대기(Circular-Wait)

- 프로세스들이 자신의 자원을 보유한 채로 서로 상대방의 자원을 요청하고 결과적으로 대기 상태가 되어버리는 과정에서 교착 상태가 발생

![image](https://github.com/java-two-people-get-in/Dododok-CS-study/assets/102593738/5f01d161-5cbd-4672-a1c8-a5d808445f03)

<br/><br/>

## 2 교착 상태의 해결

### 2.1 예방

- 교착 상태를 아예 막는 방법
- 가장 확실하지만, 자원의 심각한 낭비와 특정 프로세스의 무한 대기 가능성이라는 문제점을 지님
    
    ### 2.1.1 자원의 배타적 사용 조건을 배제
    
    - 배타적으로밖에 사용하지 못하는 자원의 경우, 이를 이용해 교착 상태를 예방하기는 어려움
    
    ### 2.1.2 자원의 부분 할당을 배제 (=all at once)
    
    - 부분 할당을 없앤다 === 모두 할당(Total Allocation)하겠다!
    - 프로세스들은 각자 자신이 필요한 모든 자원을 미리 할당받아 실행을 시작함
        - 실행 도중 자원을 요구할 일도, 대기 상태가 될 일도 없음
    - [문제점]
        - 자원의 낭비
            - 일부 자원만 확보되면 시작할 수 있음에도 불구하고 모든 것을 할당받을 때까지 기다려야 함
        - 무한 대기
    
    ### 2.1.3 자원의 선점 가능성을 배제
    
    - 실행 도중 자원을 내어놓는 프로세스는 비정상적인 종료와 함께 심할 경우 처음부터 다시 시작해야 함
    
    ### 2.1.4 자원의 환형 대기 상황을 배제 (=linear ordering)
    
    - 자원들을 일직선상에 순서를 정해놓은 후, 프로세스드른 자원의 요청을 순서대로 한 방향으로만 할 수 있도록 함
    - [문제점]
        - 자원의 낭비
        - 프로세스의 무한대기

<br/>

### 2.2 회피

- 교착상태로 가는 것을 막겠다는 점에서 예방기법과 동일
- 안전 상태(Safe State)로만 가도록 지속적으로 제어하는 기법
    
   ![image](https://github.com/java-two-people-get-in/Dododok-CS-study/assets/102593738/2ed64153-9c74-4165-bfe9-3c49345e5016)


### 2.2.1 Dijkstra의 은행가 알고리즘

- 가정
    - 시스템 내의 프로세스 수 고정
    - 자원의 수 고정
    - 각 프로세스가 요구할 자원의 최대 개수를 알아야 함
    - 할당받은 자원을 사용 후 반드시 반납해야 함
- “현 상태에서 모든 프로세스가 정상적으로 종료할 수 있는 길이 적어도 하나 이상 있는가”
- ex) Safe state
    
    ![image](https://github.com/java-two-people-get-in/Dododok-CS-study/assets/102593738/bf366aef-3333-43db-ab72-bb9d49e08e95)

- ex) Unsafe state
    
    ![image](https://github.com/java-two-people-get-in/Dododok-CS-study/assets/102593738/5bec44be-bb57-49d1-a12b-cdc4aff7ae6f)

<br/>

### 3) 탐지 (+ Recovery)

- 교착 상태 발생되도록 놓아두다가, 발생 시 혹은 발생 후에 탐지해서 조치하는 방법

<br/>

### 4) 복구

- 프로세스들이 자신의 자원을 보유한 채로 서로 상대방의 자원을 요청하고 결과적으로 대기 상태가 되어버리는 과정에서 교착 상태가 발생

<br/><br/>

### Quiz!

- Deadlock의 해결 방법에는 어떤 게 있을까요?
- 예방, 회피 기법과 탐지 기법의 차이는 무엇일까요?
